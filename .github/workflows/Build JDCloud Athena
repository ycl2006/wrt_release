name: Build Athena LibWRT (IPQ6010)

on:
  workflow_dispatch:
  push:
    paths:
      - 'compilecfg/jdcloud_ipq60xx_libwrt.ini'
      - 'build_athena_libwrt.sh'
      - '.github/workflows/athena-libwrt.yml'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 rsync unzip \
          zlib1g-dev file wget dos2unix

    - name: Init ImmortalWrt build env
      run: |
        bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)

    - name: Build Athena LibWRT
      run: |
        chmod +x build.sh build_athena_libwrt.sh
        ./build_athena_libwrt.sh

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: athena-ipq6010-libwrt
        path: |
          bin/targets/**/*