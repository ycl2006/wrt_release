name: Build Athena Firmware

on:
  push:
    branches:
      - master  # 或你自己的分支
  workflow_dispatch:

jobs:
  build:
    name: Build Athena RE-CS-02
    runs-on: ubuntu-latest

    env:
      # 设置 CCACHE 路径，加快编译
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      TARGET_CONFIG: jdcloud_ipq60xx_libwrt_athena_homeproxy.config

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: true  # 如果 feeds 或 libwrt 是 submodule，需要打开

    - name: Set up ccache
      run: |
        mkdir -p $CCACHE_DIR
        export CCACHE_DIR=$CCACHE_DIR
        export CCACHE_MAXSIZE=2G
        ccache -M $CCACHE_MAXSIZE

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git-core libncurses5-dev zlib1g-dev gawk gcc-multilib flex gettext unzip python3-distutils python3-setuptools rsync wget file libssl-dev subversion

    - name: Prepare configuration
      run: |
        mkdir -p deconfig
        cp deconfig/${TARGET_CONFIG} .config
        # 应用 diffconfig 到 OpenWrt/LibWRT 编译系统
        scripts/diffconfig.sh > .config

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build firmware
      run: |
        make defconfig
        make -j$(nproc) V=s

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v3
      with:
        name: athena-firmware
        path: bin/targets/qualcommax/ipq60xx/