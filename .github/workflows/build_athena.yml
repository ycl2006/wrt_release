name: Build & Release wrt_release Firmware (Auto Cleanup)
run-name: Build & Release Firmware

on:
  push:
    tags:
      - 'v*.*.*'      # 例如 v1.0.0 触发
  workflow_dispatch:
    inputs:
      model:
        description: "Target Build Model"
        required: true
        type: choice
        default: jdcloud_ipq60xx_libwrt_athena_homeproxy
        options:
          - jdcloud_ipq60xx_libwrt_athena_homeproxy
          - jdcloud_ipq60xx_libwrt
          - redmi_ax6_libwrt

jobs:
  build_release:
    runs-on: ubuntu-24.04
    env:
      MODEL: ${{ github.event.inputs.model }}
      TAG_NAME: ${{ github.ref_name }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Free disk space
      uses: sbwml/actions@free-disk

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git-core libncurses5-dev zlib1g-dev \
          gawk gcc-multilib flex gettext unzip python3-dev python3-setuptools \
          python3-venv rsync wget file libssl-dev subversion dos2unix libfuse-dev jq

    - name: Set Build Date
      run: |
        export BUILD_DATE=$(date +"%y.%m.%d_%H.%M.%S")
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

    - name: Prepare Build Config
      run: |
        CONFIG_FILE="deconfig/${MODEL}.config"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "Error: $CONFIG_FILE not found!"
          exit 1
        fi
        cp "$CONFIG_FILE" .config
        scripts/diffconfig.sh > .config
        # 自动启用 HomeProxy
        echo "CONFIG_PACKAGE_homeproxy=y" >> .config
        echo "Build config ready for $MODEL"

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          dl
          build_dir
          staging_dir
          .ccache
        key: ${{ runner.os }}-wrt_${{ env.MODEL }}-${{ hashFiles('deconfig/**') }}
        restore-keys: |
          ${{ runner.os }}-wrt_${{ env.MODEL }}-

    - name: Build Firmware
      run: |
        make defconfig
        make -j$(nproc) V=s

    - name: Collect Firmware
      run: |
        mkdir -p release_bin
        cp bin/targets/**/* release_bin/ || true
        tar -czvf firmware_${MODEL}_${BUILD_DATE}.tar.gz release_bin/
        echo "Firmware archived."

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        tag_name: ${{ github.ref_name }}
        name: Firmware ${{ github.ref_name }} - ${{ env.MODEL }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Firmware to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: firmware_${MODEL}_${BUILD_DATE}.tar.gz
        asset_name: firmware_${MODEL}_${BUILD_DATE}.tar.gz
        asset_content_type: application/gzip

    - name: Cleanup Old Releases (Keep latest 5)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "Cleaning old releases, keeping latest 5..."
        # 登录 GH API
        gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
        releases=$(gh api repos/${{ github.repository }}/releases --jq '. | sort_by(.created_at) | reverse | .[5:] | .[].id')
        for rid in $releases; do
          echo "Deleting old release $rid"
          gh api -X DELETE repos/${{ github.repository }}/releases/$rid
        done