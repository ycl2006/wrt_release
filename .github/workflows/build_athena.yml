name: Athena Full Auto Build
run-name: Athena Full Auto Build

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      model:
        description: "Device Model"
        required: true
        default: jdcloud_ipq60xx_libwrt_athena_homeproxy

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      MODEL: ${{ github.event.inputs.model }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: wrt_release
        submodules: true

    - name: Show workspace
      run: |
        echo "Workspace: $GITHUB_WORKSPACE"
        ls -R $GITHUB_WORKSPACE

    - name: Free disk space
      uses: sbwml/actions@free-disk

    - name: Set Build Date
      run: |
        sudo timedatectl set-timezone "Asia/Shanghai"
        export BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d_%H.%M.%S")
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git-core libncurses5-dev zlib1g-dev gawk gcc-multilib \
          flex gettext unzip python3-dev python3-setuptools python3-venv rsync wget file libssl-dev \
          subversion dos2unix libfuse-dev

    - name: Prepare Athena Config and Enable HomeProxy
      run: |
        CONFIG_FILE="$GITHUB_WORKSPACE/wrt_release/deconfig/${MODEL}.config"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "Error: Config file $CONFIG_FILE not found!"
          exit 1
        fi
        cp "$CONFIG_FILE" "$GITHUB_WORKSPACE/wrt_release/.config"
        cd $GITHUB_WORKSPACE/wrt_release
        # 保证 diffconfig 正确合并
        scripts/diffconfig.sh > .config
        # 自动启用 HomeProxy 插件
        echo "CONFIG_PACKAGE_homeproxy=y" >> .config
        echo "Athena config prepared with HomeProxy."

    - name: Update feeds
      run: |
        cd $GITHUB_WORKSPACE/wrt_release
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: |
          $GITHUB_WORKSPACE/wrt_release/dl
          $GITHUB_WORKSPACE/wrt_release/build_dir
          $GITHUB_WORKSPACE/wrt_release/staging_dir
          $GITHUB_WORKSPACE/wrt_release/.ccache
        key: ${{ runner.os }}-build-${{ github.event.inputs.model }}-${{ hashFiles('wrt_release/deconfig/**') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ github.event.inputs.model }}-

    - name: Build Firmware
      run: |
        cd $GITHUB_WORKSPACE/wrt_release
        make defconfig
        make -j$(nproc) V=s

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: Athena_${{ env.MODEL }}_${{ env.BUILD_DATE }}
        path: $GITHUB_WORKSPACE/wrt_release/bin/targets/qualcommax/ipq60xx/*.bin

    - name: Clean old artifacts
      run: |
        # 仅保留最近 5 个固件
        echo "Cleaning old artifacts..."
        gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}
        artifacts=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts | sort_by(.created_at) | reverse | .[5:] | .[].id')
        for id in $artifacts; do
          gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id
        done