name: Advanced Athena Build
run-name: Advanced Athena Build

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      model:
        description: "Device Model"
        required: true
        default: jdcloud_ipq60xx_libwrt_athena_homeproxy
        type: choice
        options:
          - jdcloud_ipq60xx_libwrt_athena_homeproxy
          - jdcloud_ax6000_libwrt
          - redmi_ax6_libwrt
          # 可扩展其他设备

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      MODEL: ${{ github.event.inputs.model }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Show workspace
      run: |
        echo "Workspace: $GITHUB_WORKSPACE"
        ls -R $GITHUB_WORKSPACE

    - name: Free disk space
      uses: sbwml/actions@free-disk

    - name: Set Build Date
      run: |
        sudo timedatectl set-timezone "Asia/Shanghai"
        export BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d_%H.%M.%S")
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential git-core libncurses5-dev zlib1g-dev gawk gcc-multilib flex gettext unzip \
          python3-dev python3-setuptools python3-venv rsync wget file libssl-dev subversion \
          dos2unix libfuse-dev

    - name: Prepare Athena Config
      run: |
        CONFIG_PATH="$GITHUB_WORKSPACE/deconfig/${MODEL}.config"
        if [ -f "$CONFIG_PATH" ]; then
          cp "$CONFIG_PATH" .config
          scripts/diffconfig.sh > .config
          echo "Config $CONFIG_PATH copied successfully."
        else
          echo "Error: Config file $CONFIG_PATH not found!"
          exit 1
        fi

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Cache Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ./dl
          ./build_dir
          ./staging_dir
          .ccache
        key: ${{ runner.os }}-build-${{ github.event.inputs.model }}-${{ hashFiles('deconfig/**') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ github.event.inputs.model }}-

    - name: Build Firmware
      run: |
        make defconfig
        make -j$(nproc) V=s

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: Athena_${{ env.MODEL }}_${{ env.BUILD_DATE }}
        path: bin/targets/qualcommax/ipq60xx/*.bin

    - name: Clean old cache (optional)
      run: |
        echo "Cleaning old caches..."
        # 这里可选择清理不需要的缓存或日志