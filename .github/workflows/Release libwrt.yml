name: Build WRT
run-name: Build - ${{ inputs.model }}


on:
  workflow_dispatch:
    inputs:
      model:
        required: true
        description: Device Model
        type: choice
        default: jdcloud_ipq60xx_immwrt
        options:
          - aliyun_ap8220_immwrt
          - cmcc_rax3000m_immwrt
          - gemtek_w1701k_immwrt
          - jdcloud_ax6000_immwrt
          - jdcloud_ipq60xx_immwrt
          - jdcloud_ipq60xx_libwrt
          - linksys_mx4x00_immwrt
          - qihoo_360v6_immwrt
          - redmi_ax5_immwrt
          - redmi_ax6_immwrt
          - redmi_ax6_libwrt
          - redmi_ax6000_immwrt21
          - zn_m2_immwrt
          - zn_m2_libwrt
          - x64_immwrt

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CCACHE_DIR: ${{ github.workspace }}/action_build/.ccache
  CCACHE_MAXSIZE: 5G

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1ï¸âƒ£ é‡Šæ”¾ç£ç›˜ï¼ˆåŸºç¡€ï¼‰
      - name: Free disk space
        uses: sbwml/actions@free-disk

      # 2ï¸âƒ£ é¢å¤–ç£ç›˜ + swap + ccache ä¼˜åŒ–ï¼ˆæ ¸å¿ƒï¼‰
      - name: Optimize runner
        run: |
          echo "== Disk cleanup =="
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
          sudo apt-get clean

          echo "== Setup swap =="
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

          echo "== Setup ccache =="
          sudo apt-get update -qq
          sudo apt-get install -y ccache
          ccache -M 5G
          ccache -z

      # 3ï¸âƒ£ æ„å»ºç¯å¢ƒï¼ˆimmortalwrt å®˜æ–¹ï¼‰
      - name: Build System Setup
        run: |
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt -yqq install dos2unix libfuse-dev
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E systemctl daemon-reload

      # 4ï¸âƒ£ æ‹‰å–ä»“åº“
      - name: Checkout
        uses: actions/checkout@v4

      # 5ï¸âƒ£ æ—¶é—´ / æ„å»ºæ ‡è¯†
      - name: Set Build Date and Timezone
        run: |
          sudo -E timedatectl set-timezone "Asia/Shanghai"
          BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d_%H.%M.%S")
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

      # 6ï¸âƒ£ é¢„å¤„ç†ï¼ˆé€‰æ‹©æºç  / configï¼‰
      - name: Pre Clone
        run: ./pre_clone_action.sh ${{ inputs.model }}

      # 7ï¸âƒ£ ç¼“å­˜ï¼ˆccache + stagingï¼‰
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ./action_build/.ccache
            ./action_build/staging_dir
          key: ${{ runner.os }}-${{ hashFiles('**/repo_flag') }}
          restore-keys: |
            ${{ runner.os }}-

      # 8ï¸âƒ£ åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³ï¼ˆé˜²æ­¢è¯¯åˆ¤è¿‡æœŸï¼‰
      - name: Refresh the cache
        run: |
          if [ -d "./action_build/staging_dir" ]; then
            find "./action_build/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
              find "$dir" -type f -exec touch {} +
            done
          fi

      # 9ï¸âƒ£ æ­£å¼ç¼–è¯‘
      - name: Build Firmware
        run: ./build.sh ${{ inputs.model }}

      # ğŸ”Ÿ æ˜¾ç¤º ccache å‘½ä¸­ç‡ï¼ˆéªŒè¯ä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆï¼‰
      - name: Show ccache stats
        run: ccache -s

      # 1ï¸âƒ£1ï¸âƒ£ æ¸…ç†æ—§ç¼“å­˜ï¼ˆé˜²æ­¢æ— é™è†¨èƒ€ï¼‰
      - name: Delete Old Cache
        run: |
          gh cache list --json key --jq '.[].key' | while read -r key; do
            gh cache delete "$key" || true
          done
          echo "======== cache status ========"
          du -sh ./action_build/.ccache || true
          du -sh ./action_build/staging_dir || true

      # 1ï¸âƒ£2ï¸âƒ£ æœºå™¨ä¿¡æ¯ï¼ˆæ–¹ä¾¿æ’é”™ï¼‰
      - name: Machine Information
        run: |
          echo "=============================================="
          lscpu | grep -E "Model name|Core|Thread"
          echo "=============================================="
          df -h
          echo "=============================================="

      # 1ï¸âƒ£3ï¸âƒ£ ä¸Šä¼ å›ºä»¶
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_DATE }}_${{ inputs.model }}
          path: ./firmware/*.*