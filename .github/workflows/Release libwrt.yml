name: Release libwrt
run-name: Release - ${{ inputs.model }}

on:
  workflow_dispatch:
    inputs:
      model:
        required: true
        description: Device Model (libwrt ini)
        type: choice
        default: jdcloud_ipq60xx_libwrt_athena_homeproxy
        options:
          - jdcloud_ipq60xx_libwrt_athena_homeproxy

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    runs-on: ubuntu-24.04   # ★ 关键：不要再用 22.04 / 24.04

    steps:
      - name: Free disk space
        uses: sbwml/actions@free-disk

      - name: Checkout wrt_release
        uses: actions/checkout@v4

      # =================================================
      # APT HARD RESET（核心止血）
      # =================================================
      - name: Fix APT environment
        run: |
          set -euxo pipefail
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /var/cache/apt/archives/*
          sudo dpkg --configure -a || true
          sudo apt-get clean
          sudo apt-get update

      # =================================================
      # Build Environment（绝对稳）
      # =================================================
      - name: Install build dependencies
        run: |
          set -euxo pipefail
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext \
            git libncurses-dev libssl-dev python3 \
            rsync unzip zlib1g-dev file wget \
            dos2unix libfuse-dev ca-certificates

      # =================================================
      # Time & Build Info
      # =================================================
      - name: Set Build Date and Info
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d_%H.%M.%S")
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

          BUILD_SRC=$(awk -F"=" '/REPO_URL/ {print $NF}' "./compilecfg/${{ inputs.model }}.ini")
          echo "BUILD_SRC=$BUILD_SRC" >> $GITHUB_ENV

      # =================================================
      # Pre Clone
      # =================================================
      - name: Pre Clone
        run: |
          chmod +x pre_clone_action.sh
          ./pre_clone_action.sh ${{ inputs.model }}

      # =================================================
      # Cache
      # =================================================
      - name: Cache build dependencies
        uses: actions/cache@v4
        with:
          path: |
            ./action_build/.ccache
            ./action_build/staging_dir
          key: libwrt-${{ runner.os }}-${{ hashFiles(format('compilecfg/{0}.ini', inputs.model)) }}
          restore-keys: |
            libwrt-${{ runner.os }}-

      - name: Refresh staging timestamp
        run: |
          if [ -d "./action_build/staging_dir" ]; then
            find "./action_build/staging_dir" -type d -name "stamp" -not -path "*target*" \
              -exec find {} -type f -exec touch {} + \;
          fi

      # =================================================
      # Build
      # =================================================
      - name: Build Firmware
        run: |
          chmod +x build.sh
          ./build.sh ${{ inputs.model }}

      # =================================================
      # Kernel Version
      # =================================================
      - name: Get Kernel Version
        run: |
          KVER=$(grep -oP "^kernel.*" ./firmware/*.manifest \
            | grep -oP "[4-6]\.[0-9]{1,3}\.[0-9]{1,3}" | head -n1)
          echo "KVER=$KVER" >> $GITHUB_ENV

      # =================================================
      # Release Body
      # =================================================
      - name: Prepare Release Body
        run: |
          {
            echo "libwrt 云编译发布"
            echo ""
            echo "源码：${BUILD_SRC}"
            echo "设备：JDCloud RE-CS-02 (ipq60xx)"
            echo "Kernel：${KVER}"
            echo ""
            echo "插件列表："
            grep -oP "luci-app(-[a-zA-Z0-9]+)+" ./firmware/*.manifest \
              | awk -F: '{print $NF}' | sort -u
          } > release_body.txt

      # =================================================
      # Release
      # =================================================
      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.BUILD_DATE }}_${{ inputs.model }}
          files: ./firmware/*.*
          body_path: ./release_body.txt